<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager - Planet of Sound Rock School</title>
  </head>
  <body>
    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <!-- Repository access control -->
    <script>
      // Track if we've already shown an access denied message
      let accessDenied = false;
      let originalBodyContent = null;
      
      // Function to show persistent error message
      function showAccessDeniedMessage(message) {
        if (accessDenied) return; // Prevent multiple error displays
        
        accessDenied = true;
        console.log('Access denied:', message);
        
        // Store original content if not already stored
        if (!originalBodyContent) {
          originalBodyContent = document.body.innerHTML;
        }
        
        // Clear the page content and show error
        document.body.innerHTML = `
          <div id="access-denied-container" style="
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
          ">
            <div style="
              background: white;
              padding: 2rem;
              border-radius: 8px;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
              max-width: 500px;
              text-align: center;
            ">
              <div style="color: #dc3545; font-size: 48px; margin-bottom: 1rem;">ðŸš«</div>
              <h1 style="color: #333; margin-bottom: 1rem; font-size: 24px;">Access Denied</h1>
              <p style="color: #666; margin-bottom: 1.5rem; line-height: 1.5; font-size: 16px;">${message}</p>
              <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; font-size: 14px;">
                <strong>To request access:</strong><br>
                Contact the repository administrator to be added as a collaborator with <strong>Write</strong> permissions.
              </div>
              <div style="margin-bottom: 1rem;">
                <button onclick="window.location.href='/admin/';" style="
                  background: #6c757d;
                  color: white;
                  border: none;
                  padding: 0.5rem 1rem;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 14px;
                  margin-right: 0.5rem;
                ">Try Again</button>
                <button onclick="window.location.href='/';" style="
                  background: #007bff;
                  color: white;
                  border: none;
                  padding: 0.5rem 1rem;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 14px;
                ">Return to Website</button>
              </div>
            </div>
          </div>
        `;
        
        // Prevent any further CMS initialization
        if (window.CMS) {
          try {
            // Stop the CMS if it's running
            const cmsElement = document.querySelector('[data-react-root]');
            if (cmsElement) {
              cmsElement.remove();
            }
          } catch (e) {
            console.log('Could not stop CMS:', e);
          }
        }
      }
      
      // Check permissions when CMS is ready
      async function checkRepositoryAccess(token) {
        try {
          console.log('Checking repository access...');
          
          // First, try to get collaborator info (requires write access)
          const collaboratorsResponse = await fetch(
            'https://api.github.com/repos/planetofsoundrockschool/planetofsoundrockschool.github.io/collaborators',
            {
              headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            }
          );
          
          if (collaboratorsResponse.status === 200) {
            console.log('User has collaborator access');
            return true;
          }
          
          // If that fails, check repository permissions directly
          const repoResponse = await fetch(
            'https://api.github.com/repos/planetofsoundrockschool/planetofsoundrockschool.github.io',
            {
              headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            }
          );
          
          if (repoResponse.status === 200) {
            const repoData = await repoResponse.json();
            console.log('Repository permissions:', repoData.permissions);
            
            // Check if user has push (write) or admin permissions
            if (repoData.permissions && (repoData.permissions.push || repoData.permissions.admin)) {
              console.log('User has write/admin access');
              return true;
            }
          }
          
          console.log('User does not have sufficient permissions');
          return false;
          
        } catch (error) {
          console.error('Error checking repository access:', error);
          return false;
        }
      }
      
      // Intercept login attempts
      window.addEventListener('load', () => {
        // Wait a bit for CMS to initialize
        setTimeout(() => {
          if (window.CMS) {
            console.log('CMS detected, setting up access control');
            
            // Override the login process
            CMS.registerEventListener({
              name: 'login',
              handler: async ({ author, token }) => {
                console.log('Login attempt detected for:', author.name);
                
                if (accessDenied) {
                  console.log('Access already denied, blocking login');
                  return;
                }
                
                const hasAccess = await checkRepositoryAccess(token);
                
                if (!hasAccess) {
                  showAccessDeniedMessage(
                    `Hello ${author.name || 'there'}! You do not have write access to this repository. Only users with Write or Admin permissions can access the content management system.`
                  );
                  
                  // Throw an error to prevent login continuation
                  throw new Error('Access denied: Insufficient repository permissions');
                }
                
                console.log('Access granted for:', author.name);
                return true;
              }
            });
            
            // Also check on logout (in case someone tries to login again)
            CMS.registerEventListener({
              name: 'logout',
              handler: () => {
                console.log('User logged out');
                accessDenied = false;
                originalBodyContent = null;
              }
            });
          }
        }, 1000);
      });
      
      // Prevent navigation away from error page
      window.addEventListener('beforeunload', (e) => {
        if (accessDenied && !e.target.location.href.includes('/admin/') && !e.target.location.href.includes('/')) {
          e.preventDefault();
          e.returnValue = '';
          return '';
        }
      });
    </script>
  </body>
</html>
